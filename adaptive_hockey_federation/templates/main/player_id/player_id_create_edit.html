{% extends 'base/base.html' %}
{% load static %}
{% load user_filters %}
{% block title %}
    {{ page_title }}
{% endblock %}

{% block content %}
<h2 class="text-center mb-4">{{ page_title }}</h2>

<form id="playerForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="container text-center">
        <div class="full-container">
            <h4 class="text-center mb-4">Личная информация</h4>
            <table class="table-table">
                <tbody>
                  {% for field in form.visible_fields %}
                    {% if field.name in 'surname name patronymic birthday identity_document'%}
                      <tr>
                        <th>{{ field.label_tag }}</th>
                          <td>
                            {% if field.errors %}
                              {{ field |addclass:'base-input-errors'}}
                              {{ field.errors }}
                            {% else %}
                              {{ field |addclass:'base-input'}}
                            {% endif %}
                          </td>
                      <tr>
                    {% elif  field.name in 'gender discipline diagnosis' %}
                      <tr>
                        <th>{{ field.label_tag }}</th>
                            <td>
                              {% if field.errors %}
                                {{ field |addclass:'base-select-errors'}}
                                {{ field.errors|striptags}}
                              {% else %}
                                {{ field |addclass:'base-select'}}
                              {% endif %}
                            </td>
                      </tr>
                        {% endif %}
                  {% endfor %}
                </tbody>
              </table>
        </div>
        <div class="full-container">
            <h4 class="text-center mb-4">Игровая информация</h4>
            <table class="table-table">
              {% for field in form.visible_fields %}
                {% if field.name in "level_revision number"%}
                    <tr>
                      <th>{{ field.label_tag }}</th>
                        <td>
                          {% if field.errors %}
                            {{ field |addclass:"base-input-errors"}}
                            {{ field.errors }}
                          {% else %}
                            {{ field |addclass:"base-input"}}
                          {% endif %}
                        </td>
                    <tr>
                  {% elif  field.name in "team" %}
                  <tr>
                    <th>{{ field.label_tag }}</th>
                        <td>
                          {% if field.errors %}
                            {{ field |addclass:"base-select-errors"}}
                            {{ field.errors|striptags}}
                          {% else %}
                            <div class="selector">
                              <div class="selector-available">
                                <h2> Доступные команды 
                                  <span class="help help-tooltip help-icon" title="Список доступных команд, можно выбрать несколько"></span>
                                </h2>
                                <p id="id_teams_filter" class="selector-filter">
                                  <label for="id_teams_input">
                                      <span class="help-tooltip search-label-icon" title="Начните вводить текст в этом поле, чтобы отфитровать список доступных команд."></span>
                                  </label>
                                  <input type="text" placeholder="Фильтр" id="id_teams_input">
                                </p>
                                {{ field |addclass:"selector-list"}}
                                <div class="list-footer-display">
                                  <span id="id_users_list-footer-display-text"></span>
                                  <span class="list-footer-display__clear"></span>
                                </div>
                                <a title="Нажмите, чтобы выбрать все команды сразу." href="#" id="id_teams_add_all_link" class="selector-chooseall active">Выбрать все</a>
                              </div>
                                <ul class="selector-chooser">
                                  <li>
                                    <a title="Выбрать" href="#" id="id_teams_add_link" class="selector-add active">Выбрать</a>
                                  </li>
                                  <li>
                                    <a title="Удалить" href="#" id="id_teams_remove_link" class="selector-remove active">Удалить</a>
                                  </li>
                                </ul>
                              <div id="id_team_selector_chosen" class="selector-chosen">
                                <h2> Выбранные команды 
                                  <span class="help help-tooltip help-icon" title="Команды в которых состоит игрок"></span>
                                </h2>
                                <p id="id_player_teams_filter" class="selector-filter">
                                  <label for="id_player_teams_input">
                                      <span class="help-tooltip search-label-icon" title="Начните вводить текст в этом поле, чтобы отфитровать список команд игрока."></span>
                                  </label>
                                  <input type="text" placeholder="Фильтр" id="id_player_teams_input">
                                </p>
                                {{ form.player_team |addclass:"selector-list"}}
                                <a title="Нажмите чтобы удалить все команды сразу." href="#" id="id_teams_remove_all_link" class="selector-clearall active">Удалить все</a>
                              </div>
                            </div>
                          {% endif %}
                        </td>
                  </tr>
                  {% elif  field.name in "is_captain is_assistent" %}
                    <tr>
                      <th>{{ field.label_tag }}</th>
                        <td>
                          {{ field |addclass:"base-checkbox"}}
                        </td>
                    </tr>
                  {% elif  field.name in "position" %}
                    <tr>
                      <th>{{ field.label_tag }}</th>
                        <td>
                          {% if field.errors %}
                            {{ field |addclass:'base-select-errors'}}
                            {{ field.errors|striptags}}
                          {% else %}
                            {{ field |addclass:'base-select'}}
                          {% endif %}
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
              </tbody>
            </table>
        </div>
        <h4 class="text-center mb-4">Документы</h4>
        <table class="table-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Файл</th>
                    <th>Удалить</th>
                </tr>
            </thead>
            <tbody id="fileUploadContainer">
            {% if player_documents %}
                {% for doc in player_documents %}
                    <tr>
                        <td>{{ doc.name }}</td>
                        <td><a href="{{ doc.file.url }}" target="_blank">Просмотреть</a></td>
                        <td><button id="deleteFileButton" type="button" class="btn btn-danger">-</button></td>
                    </tr>
                {% endfor %}
            {% endif %}
            </tbody>
        </table>
        <button id="addFileButton" type="button" class="btn btn-primary">+</button>
        {% if team_id %}
        <input type="hidden" value="{{ team_id }}" name="team_id" >
        {% endif %}
        <!-- Save Button -->
        <div class="container">
            <div class="row">
                <div class="col text-center text-white flex justify-start">
                    <button
                    type="submit"
                    class="btn btn-secondary text-white"
                    style="background-color: #64C2D1; border: 1px solid #fff;"
                    >
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}
{% block JavaScript %}
<script>
let deleteButtons = document.querySelectorAll("#deleteFileButton");

function addDeleteButtonEvent(button) {
    button.addEventListener("click", function() {
        const parentRow = this.closest("tr");
        const a_tag = parentRow.querySelector("a");
        if (a_tag) {
            const fileName = a_tag.getAttribute("href");
            let hiddenInput = document.createElement("input");
            hiddenInput.style.display = "none";
            hiddenInput.name = "deleted_file_path[]";
            hiddenInput.value = fileName;
            parentRow.appendChild(hiddenInput);
        }
        parentRow.style.display = "none";
    });
}

function addNewFileField() {
        let fileUploadContainer = document.getElementById('fileUploadContainer');
    let newFileUpload = document.createElement("tr");
    newFileUpload.classList.add("file-upload-container");
    newFileUpload.classList.add("m-2");
    newFileUpload.innerHTML = `
            <td><input type="text" name="new_file_name[]" placeholder="Name" class="form-control"></td>
            <td><input type="file" name="new_file_path[]" accept="{{ file_resolution }}" class="form-control"></td>
        `;
    const deleteButton = document.createElement("button");
    deleteButton.id = "deleteFileButton";
    deleteButton.type = "button";
    deleteButton.className = "btn btn-danger";
    deleteButton.textContent = "-";
    addDeleteButtonEvent(deleteButton);

    const newTd = document.createElement("td");
    newTd.appendChild(deleteButton);
    newFileUpload.appendChild(newTd);
    fileUploadContainer.appendChild(newFileUpload);
}

deleteButtons.forEach(function(button) {
    addDeleteButtonEvent(button);
});

document.getElementById('addFileButton').addEventListener('click', function() {
    addNewFileField()
});

addNewFileField()
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const availableCommands = [
      'Артемьев Э. Н.',
      'Афхимов Р. Ф.',
      'Белозеров С. Л.',
      'Белоусова П. З.',
      'Беляков Т. О.',
      'Голубев С. В.',
      'Данилов Г. П.',
      'Дорзадов Г. П.',
      'Зимин М. Ф.',
      'Иванов Е. Т.',
      'Костина О. А.',
      'Куликов И. С.'
      ]
  
      const availableList = document.getElementById('available-list')
      const selectedList = document.getElementById('select-list')
      const deleteAllButton = document.getElementById('delete-all-button')
      const selectAllButton = document.getElementById('select-all-button')
      const searchAvailableInput = document.getElementById(
      'search-available-selector'
      )
      const searchSelectInput = document.getElementById(
      'search-select-selector'
      )
  
      const elements = {
      availableList,
      selectedList,
      deleteAllButton,
      selectAllButton,
      searchAvailableInput,
      searchSelectInput
      }
  
      const selector = new Selector(availableCommands, elements)
    })
  </script>
{% endblock %}
